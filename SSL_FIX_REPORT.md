# Отчет о проблеме SSL для supermock.ru

## Проблема
Домен `supermock.ru` не имеет безопасного HTTPS соединения (SSL сертификат от Let's Encrypt не выдается).

## Причина
1. **HTTP редирект блокирует ACME challenge**: HTTP роутер для `supermock.ru` применял middleware `redirect-to-https`, который редиректил ВСЕ HTTP запросы на HTTPS, включая путь `/.well-known/acme-challenge/`, необходимый для проверки домена Let's Encrypt.

2. **Let's Encrypt видит другой IP**: При попытке получения сертификата Let's Encrypt видит IP `217.198.6.238` (Timeweb) вместо `168.222.255.226` (сервер). Это может указывать на:
   - Прокси/CDN перед сервером
   - Проблемы с DNS кешированием
   - Разные DNS серверы

## Решение
Исправлена конфигурация Traefik: добавлено исключение для пути ACME challenge из редиректа.

**Файл**: `/etc/dokploy/traefik/dynamic/supermock-nextjs-a1uugu.yml`

**Изменение**:
```yaml
# Было:
rule: Host(`supermock.ru`)

# Стало:
rule: Host(`supermock.ru`) && !PathPrefix(`/.well-known/acme-challenge`)
```

Это позволяет Let's Encrypt получать доступ к пути `/.well-known/acme-challenge/` по HTTP без редиректа.

## Выполненные действия
1. ✅ Обновлена конфигурация Traefik для исключения ACME challenge из редиректа
2. ✅ Удален старый ACME файл для принудительного обновления сертификата
3. ✅ Перезапущен Traefik для применения изменений

## Следующие шаги
1. **Подождать автоматического обновления**: Traefik автоматически попытается получить сертификат в течение нескольких минут/часов.

2. **Проверить DNS**: Убедиться, что:
   - DNS запись A для `supermock.ru` указывает на `168.222.255.226`
   - Нет прокси/CDN перед сервером, который может мешать
   - DNS полностью распространился

3. **Проверить логи**: Через несколько минут проверить логи Traefik:
   ```bash
   docker logs dokploy-traefik --tail 50 | grep supermock
   ```

4. **Проверить сертификат**: После успешного получения сертификата:
   ```bash
   curl -vI https://supermock.ru
   ```

## Проверка статуса
- DNS: ✅ Указывает на `168.222.255.226`
- Traefik: ✅ Запущен, порты 80 и 443 открыты
- Конфигурация: ✅ Исправлена (ACME challenge исключен из редиректа)
- Сертификат: ⏳ Ожидание автоматического обновления

## Важно
⚠️ **Внимание**: Если Dokploy автоматически перезаписывает конфигурационные файлы, изменения могут быть потеряны. В этом случае необходимо:
1. Обновить конфигурацию домена через интерфейс Dokploy
2. Или создать скрипт для автоматического применения исправления

## Альтернативное решение
Если проблема с IP `217.198.6.238` сохраняется, можно:
1. Использовать DNS challenge вместо HTTP challenge (требует настройки DNS API)
2. Проверить наличие прокси/CDN и правильно его настроить
3. Убедиться, что DNS полностью распространился

---
Дата исправления: 2025-12-06
IP сервера: 168.222.255.226
Домен: supermock.ru

